---
import { Icon } from "astro-icon/components";

const menuItems = [
  { text: "Sobre mí", href: "#about" },
  { text: "Proyectos", href: "#projects" },
  { text: "Servicios", href: "#services" },
];

const whatsappLink = `https://wa.me/+5353118193?text=${encodeURIComponent("Hola, me interesa trabajar contigo.")}`;
---

<header class="fixed w-full liquid-glass z-50 top-0 border-b border-white/20 transition-all duration-300" id="main-header">
  <nav class="container-custom flex justify-between items-center h-20 md:h-24">
    <!-- Logo with Gold Accent -->
    <a href="#" 
       id="site-logo"
       class="group flex items-center gap-2 specular-highlight"
       aria-label="thejasondev - Jason Guerra Portfolio">
       <span class="text-2xl font-bold font-heading text-black tracking-tight group-hover:text-gradient-gold transition-all duration-300">
         {'{ thejasondev }'}
       </span>
    </a>

    <!-- Desktop Menu -->
    <div class="hidden md:flex items-center gap-10">
      <ul class="flex gap-8">
        {menuItems.map(item => (
          <li>
            <a
              href={item.href}
              class="text-xs font-bold text-neutral-700 hover:text-black transition-colors uppercase tracking-widest relative group"
            >
              {item.text}
              <span class="absolute -bottom-1 left-0 w-0 h-0.5 bg-gradient-to-r from-gold to-gold-light transition-all duration-300 group-hover:w-full"></span>
            </a>
          </li>
        ))}
      </ul>
      <a
        href={whatsappLink}
        target="_blank"
        rel="noopener noreferrer"
        class="btn-primary py-3 px-6 text-xs"
      >
        Contáctame
      </a>
    </div>

    <!-- Mobile Menu Button -->
    <button
      id="menu-toggle"
      class="md:hidden relative w-12 h-12 flex items-center justify-center text-black focus:outline-none focus-visible:ring-2 focus-visible:ring-gold rounded-lg transition-all z-50"
      aria-label="Abrir menú de navegación"
      aria-expanded="false"
      aria-controls="mobile-menu"
    >
      <div class="w-6 h-5 relative flex flex-col justify-between">
        <span class="w-full h-0.5 bg-current transform transition-all duration-300 ease-out"></span>
        <span class="w-full h-0.5 bg-current transition-all duration-300 ease-out"></span>
        <span class="w-full h-0.5 bg-current transform transition-all duration-300 ease-out"></span>
      </div>
    </button>
  </nav>
</header>

<!-- Mobile Menu Overlay with Liquid Glass -->
<div
  id="mobile-menu"
  class="fixed inset-0 liquid-glass-dark z-40 flex flex-col justify-center items-center opacity-0 pointer-events-none transition-all duration-300"
  aria-modal="true"
  role="dialog"
  aria-label="Menú de navegación móvil"
>
  <!-- Close Button - Dedicated and Prominent -->
  <button
    id="close-menu"
    class="fixed top-6 right-6 w-14 h-14 rounded-full liquid-glass-gold flex items-center justify-center text-black hover:scale-110 active:scale-95 transition-all duration-300 shadow-xl focus:outline-none focus-visible:ring-2 focus-visible:ring-white opacity-0 pointer-events-none"
    aria-label="Cerrar menú"
  >
    <Icon name="mdi:close" class="w-7 h-7" />
  </button>

  <!-- Menu Container -->
  <nav class="relative z-10">
    <ul class="space-y-8 text-center px-8">
      {menuItems.map((item, index) => (
        <li class="transform translate-y-4 opacity-0 transition-all duration-500 ease-out" style={`transition-delay: ${index * 80}ms`}>
          <a
            href={item.href}
            class="menu-link block text-4xl md:text-5xl font-heading font-bold text-white hover:text-gradient-gold transition-all duration-300 py-3 px-6 rounded-2xl hover:liquid-glass-gold focus:outline-none focus-visible:ring-2 focus-visible:ring-gold"
          >
            {item.text}
          </a>
        </li>
      ))}
      <li class="transform translate-y-4 opacity-0 transition-all duration-500 ease-out pt-4" style={`transition-delay: ${menuItems.length * 80}ms`}>
        <a
          href={whatsappLink}
          target="_blank"
          rel="noopener noreferrer"
          class="menu-link inline-flex items-center gap-3 text-lg font-bold text-gold hover:text-gold-light border-b-2 border-gold pb-2 transition-all duration-300 focus:outline-none focus-visible:ring-2 focus-visible:ring-gold rounded px-4"
        >
          <Icon name="mdi:whatsapp" class="w-6 h-6" />
          Iniciar conversación 
          <Icon name="mdi:arrow-right" class="w-5 h-5 transition-transform group-hover:translate-x-1" />
        </a>
      </li>
    </ul>
  </nav>
</div>

<style>
  /* Hamburger to X Animation - Enhanced */
  #menu-toggle.active span:nth-child(1) {
    transform: rotate(45deg) translate(6px, 6px);
  }
  #menu-toggle.active span:nth-child(2) {
    opacity: 0;
    transform: scaleX(0);
  }
  #menu-toggle.active span:nth-child(3) {
    transform: rotate(-45deg) translate(6px, -6px);
  }

  /* Change hamburger color when menu is open */
  #menu-toggle.active {
    color: white;
  }

  /* Mobile Menu Active State */
  #mobile-menu.active {
    opacity: 1;
    pointer-events: auto;
  }
  
  #mobile-menu.active li,
  #mobile-menu.active #close-menu,
  #mobile-menu.active #tap-hint {
    opacity: 1;
    transform: translateY(0);
    pointer-events: auto;
  }

  /* Close button animation */
  #mobile-menu.active #close-menu {
    animation: bounceIn 0.5s ease-out 0.3s both;
  }

  @keyframes bounceIn {
    0% { transform: scale(0); opacity: 0; }
    50% { transform: scale(1.1); }
    100% { transform: scale(1); opacity: 1; }
  }

  /* Menu link hover effect */
  .menu-link {
    position: relative;
  }

  .menu-link::before {
    content: '';
    position: absolute;
    inset: -8px;
    border-radius: 16px;
    opacity: 0;
    transition: opacity 0.3s;
    pointer-events: none;
  }

  .menu-link:hover::before {
    opacity: 1;
  }
</style>

<script>
  const menuToggle = document.getElementById('menu-toggle');
  const mobileMenu = document.getElementById('mobile-menu');
  const closeMenuBtn = document.getElementById('close-menu');
  const menuLinks = document.querySelectorAll('.menu-link');
  const header = document.getElementById('main-header');

  let isMenuOpen = false;

  // Function to open menu
  function openMenu() {
    isMenuOpen = true;
    menuToggle?.classList.add('active');
    mobileMenu?.classList.add('active');
    menuToggle?.setAttribute('aria-expanded', 'true');
    menuToggle?.setAttribute('aria-label', 'Cerrar menú de navegación');
    document.body.style.overflow = 'hidden';
    
    // Focus trap - focus first menu item
    setTimeout(() => {
      (menuLinks[0] as HTMLElement)?.focus();
    }, 400);
  }

  // Function to close menu
  function closeMenu() {
    isMenuOpen = false;
    menuToggle?.classList.remove('active');
    mobileMenu?.classList.remove('active');
    menuToggle?.setAttribute('aria-expanded', 'false');
    menuToggle?.setAttribute('aria-label', 'Abrir menú de navegación');
    document.body.style.overflow = '';
    
    // Return focus to toggle button
    menuToggle?.focus();
  }

  // Toggle Menu
  menuToggle?.addEventListener('click', () => {
    if (isMenuOpen) {
      closeMenu();
    } else {
      openMenu();
    }
  });

  // Close button click
  closeMenuBtn?.addEventListener('click', closeMenu);

  // Close menu on link click
  menuLinks.forEach(link => {
    link.addEventListener('click', () => {
      setTimeout(closeMenu, 100); // Small delay for better UX
    });
  });

  // Close on tap outside (on the overlay itself)
  mobileMenu?.addEventListener('click', (e) => {
    if (e.target === mobileMenu) {
      closeMenu();
    }
  });

  // Close with Escape key
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape' && isMenuOpen) {
      closeMenu();
    }
  });

  // Focus trap inside menu
  document.addEventListener('keydown', (e) => {
    if (!isMenuOpen || e.key !== 'Tab') return;

    const focusableElements = Array.from(
      mobileMenu?.querySelectorAll(
        'a[href], button:not([disabled])'
      ) || []
    ) as HTMLElement[];

    if (focusableElements.length === 0) return;

    const firstElement = focusableElements[0];
    const lastElement = focusableElements[focusableElements.length - 1];

    if (e.shiftKey) {
      // Shift + Tab
      if (document.activeElement === firstElement) {
        lastElement.focus();
        e.preventDefault();
      }
    } else {
      // Tab
      if (document.activeElement === lastElement) {
        firstElement.focus();
        e.preventDefault();
      }
    }
  });

  // Header Scroll Effect - Enhanced liquid glass
  window.addEventListener('scroll', () => {
    if (window.scrollY > 50) {
      header?.classList.add('shadow-lg');
      header?.classList.remove('liquid-glass');
      header?.classList.add('liquid-glass-dark');
    } else {
      header?.classList.remove('shadow-lg', 'liquid-glass-dark');
      header?.classList.add('liquid-glass');
    }
  });
</script>

